---
import ProjectCard from "../ProjectCard.astro";
import { projects, MAX_HOMEPAGE_PROJECTS } from "../../data/projects";
import { ProjectCarousel } from "../ui/ProjectCarousel";
import { getImage } from "astro:assets";

// Show only up to MAX_HOMEPAGE_PROJECTS on homepage
const displayedProjects = projects.slice(0, MAX_HOMEPAGE_PROJECTS);
const hasMoreProjects = projects.length > MAX_HOMEPAGE_PROJECTS;
const remainingCount = projects.length - MAX_HOMEPAGE_PROJECTS;

// Prepare data for the React Carousel component
const carouselProjects = await Promise.all(
  displayedProjects.map(async (project) => {
    const optimizedImage = await getImage({ src: project.image, format: 'webp' });
    return {
      ...project,
      image: optimizedImage.src,
    };
  })
);
---

<section class="py-32 relative" id="projects">
    <!-- Section Background -->
    <div class="absolute inset-0 grid-bg opacity-30"></div>

    <div class="container-main relative z-10">
        <!-- Section Header - Centered -->
        <div class="text-center mb-20 flex flex-col items-center">
            <div>
                <div class="number-display mb-4">// 01</div>
            </div>

            <h2 class="display-lg mb-6">
                <div>
                    <span class="block">My</span>
                    <span class="text-outline-hover">
                        <span class="outline-text">Projects</span>
                        <span class="filled-text" aria-hidden="true"
                            >Projects</span
                        >
                    </span>
                </div>
            </h2>

            <div>
                <p class="text-muted text-lg max-w-2xl mx-auto">
                    A collection of mobile and web applications built for impact.
                    Click any project to learn more.
                </p>
            </div>
        </div>

        <!-- Mobile Carousel - Visible only on small screens -->
        <div class="block md:hidden mb-8">
            <div>
                <ProjectCarousel client:load projects={carouselProjects} />
            </div>
        </div>

        <!-- Projects Grid - Modern Adaptive Layout (Desktop) -->
        <noscript>
            <div class="grid gap-8 grid-cols-1 md:grid-cols-2 lg:grid-cols-3 mb-8">
                {displayedProjects.map((project) => (
                    <div class="p-6 border rounded-lg">
                        <h3 class="text-xl font-bold mb-2"><a href={project.link}>{project.title}</a></h3>
                        <p class="mb-4">{project.description}</p>
                        <span class="text-sm text-gray-500">{project.category}</span>
                    </div>
                ))}
            </div>
        </noscript>
        
        <div class="hidden md:block">
            <div class="projects-grid">
                {
                    displayedProjects.map((project, index) => (
                        <div
                            class="project-card-wrapper"
                        >
                            <ProjectCard
                                title={project.title}
                                description={project.description}
                                category={project.category}
                                image={project.image}
                                link={project.link}
                                index={index}
                            />
                        </div>
                    ))
                }
            </div>
        </div>

        <!-- Show All Projects Button (only if more projects available) -->
        {
            hasMoreProjects && (
                <div class="mt-12 text-center flex justify-center w-full">
                    <div class="w-full sm:w-auto">
                        <a href="/projects" class="btn-secondary group w-full py-3 px-4 text-xs sm:w-auto sm:py-4 sm:px-8 sm:text-sm">
                            <span>
                                Show All Projects
                                <span class="text-accent ml-1">
                                    (+{remainingCount} more)
                                </span>
                            </span>
                            <svg
                                class="w-4 h-4 transform group-hover:translate-x-1 transition-transform"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="square"
                                    stroke-width="2"
                                    d="M17 8l4 4m0 0l-4 4m4-4H3"
                                />
                            </svg>
                        </a>
                    </div>
                </div>
            )
        }
    </div>
</section>

<style>
    /* 
     * Projects Grid - Flexbox for better centering with few items
     * Centers cards when there are 1-2, wraps to multiple rows for more
     */
    .projects-grid {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 1.5rem;
    }

    /* Each card has a max-width and grows flexibly */
    .projects-grid :global(.project-card-wrapper) {
        flex: 0 1 400px;
        max-width: 450px;
        min-width: min(100%, 320px);
    }

    /* Ensure the card inside fills the wrapper */
    .projects-grid :global(.project-card-wrapper > article) {
        height: 100%;
        width: 100%;
    }

    /* On mobile, full width */
    @media (max-width: 640px) {
        .projects-grid :global(.project-card-wrapper) {
            flex: 1 1 100%;
            max-width: 100%;
        }
    }
</style>
